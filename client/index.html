<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>MFLUX SSE Demo</title>
    <style>
      #statusList {
        background: #f9f9f9;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 20px;
        font-family: monospace;
        height: 150px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>MFLUX SSE Demo</h1>
    <p>Enter a prompt for the image:</p>

    <input
      type="text"
      id="promptInput"
      placeholder="Enter prompt"
      style="width: 300px"
    />
    <button id="generateBtn">Generate Image</button>

    <hr />

    <!-- SSE Status Messages -->
    <div id="statusList"></div>

    <!-- Generated image -->
    <div style="margin-top: 20px">
      <img id="outputImage" alt="Generated image will appear here" />
    </div>

    <!-- Power stats -->
    <div
      id="powerStats"
      style="margin-top: 20px; font-family: monospace; display: none"
    >
      <h2>Energy Consumption:</h2>
      <p><strong>CPU Power Used:</strong> <span id="cpuPower">N/A</span> W</p>
      <p><strong>GPU Power Used:</strong> <span id="gpuPower">N/A</span> W</p>
      <p><strong>RAM Power Used:</strong> <span id="ramPower">N/A</span> W</p>
      <p>
        <strong>Total Power Used:</strong>
        <span id="totalPower">N/A</span> W
        <!-- NEW: show # coffees for THIS generation if needed -->
        (<span id="thisNespresso">N/A</span> coffees)
      </p>
      <p>
        <strong>Session Energy Used:</strong>
        <span id="sessionEnergy">N/A</span> Wh
        <!-- NEW: show # coffees for session -->
        (<span id="sessionCoffees">N/A</span> coffees)
      </p>
      <p>
        <strong>Equivalent Nespresso Coffees for This Gen:</strong>
        <span id="nespressoCount">N/A</span>
      </p>
      <p>--------------------------------</p>
      <p>
        <strong>Images Generated (Lifetime):</strong>
        <span id="totalImgCount">0</span>
      </p>
      <p>
        <strong>Total Energy Used (lifetime):</strong>
        <span id="totalEnergy">N/A</span> Wh
        <!-- NEW: show # coffees for total -->
        (<span id="totalCoffees">N/A</span> coffees)
      </p>
      <!-- or you can omit the above if you're showing it in "Total Power Used" row -->
    </div>

    <!-- NEW: Macmon Note -->
    <div
      id="macmonNote"
      style="
        font-family: monospace;
        color: #666;
        margin-top: 20px;
        display: none;
        padding-bottom: 30px;
      "
    >
      <p>
        <strong>To add power consumption tracking, install macmon.</strong>
        <span style="padding: 4px; background: #222; color: #f5f5f5"
          >brew install macmon</span
        >
      </p>
    </div>

    <!-- NEW: Generation Time -->
    <div
      id="generationTimeDiv"
      style="margin-top: 20px; font-family: monospace; display: none"
    >
      <strong>Generation took:</strong> <span id="genTime">N/A</span> seconds
    </div>

    <script>
      const promptInput = document.querySelector("#promptInput");
      const generateBtn = document.querySelector("#generateBtn");
      const statusList = document.querySelector("#statusList");
      const outputImage = document.querySelector("#outputImage");
      const powerStatsDiv = document.querySelector("#powerStats");
      const macmonNote = document.querySelector("#macmonNote");
      const generationTimeDiv = document.querySelector("#generationTimeDiv");

      function appendStatus(text) {
        const div = document.createElement("div");
        div.textContent = text;
        statusList.appendChild(div);
        statusList.scrollTop = statusList.scrollHeight;
      }

      generateBtn.addEventListener("click", async () => {
        statusList.innerHTML = "";
        outputImage.src = "";
        powerStatsDiv.style.display = "none";
        macmonNote.style.display = "none";
        generationTimeDiv.style.display = "none";

        const payload = {
          model_name: "schnell",
          quantize: 8,
          seed: 42,
          prompt: promptInput.value || "Luxury food photograph",
          num_inference_steps: 2,
          height: 512,
          width: 512,
        };

        appendStatus("Sending request...");

        const response = await fetch("http://127.0.0.1:8000/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          appendStatus(`Error: ${response.status}`);
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            appendStatus("Stream finished.");
            break;
          }
          const chunk = decoder.decode(value, { stream: true });
          buffer += chunk;

          const lines = buffer.split("\n");
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith("data: ")) {
              const dataPart = line.substring(6).trim();
              if (dataPart.startsWith("{")) {
                try {
                  const jsonData = JSON.parse(dataPart);

                  // Show the final image
                  outputImage.src =
                    "data:image/png;base64," + jsonData.image_base64;

                  // NEW: show generation time
                  if (jsonData.generation_time_s !== undefined) {
                    document.querySelector("#genTime").textContent =
                      jsonData.generation_time_s.toFixed(2);
                    generationTimeDiv.style.display = "block";
                  }

                  // If macmon installed => show power
                  if (jsonData.macmon_installed) {
                    if (jsonData.power_usage) {
                      // single generation usage
                      document.querySelector("#cpuPower").textContent =
                        jsonData.power_usage.cpu_power_used.toFixed(4);
                      document.querySelector("#gpuPower").textContent =
                        jsonData.power_usage.gpu_power_used.toFixed(4);
                      document.querySelector("#ramPower").textContent =
                        jsonData.power_usage.ram_power_used.toFixed(4);
                      document.querySelector("#totalPower").textContent =
                        jsonData.power_usage.total_power_used.toFixed(4);
                      // how many coffees for this single generation
                      document.querySelector("#thisNespresso").textContent =
                        jsonData.nespresso_equiv.toFixed(4);

                      // session usage
                      document.querySelector("#sessionEnergy").textContent =
                        jsonData.session_energy_used.toFixed(4);
                      document.querySelector("#sessionCoffees").textContent =
                        jsonData.session_energy_nespresso
                          ? jsonData.session_energy_nespresso.toFixed(4)
                          : "N/A";

                      // total usage
                      document.querySelector("#totalEnergy").textContent =
                        jsonData.total_energy_used.toFixed(4);
                      document.querySelector("#totalCoffees").textContent =
                        jsonData.total_energy_nespresso
                          ? jsonData.total_energy_nespresso.toFixed(4)
                          : "N/A";
                      document.querySelector("#totalImgCount").textContent =
                        jsonData.total_image_count;

                      // old place for single generation coffees
                      document.querySelector("#nespressoCount").textContent =
                        jsonData.nespresso_equiv.toFixed(4);

                      powerStatsDiv.style.display = "block";
                      appendStatus(
                        "Final JSON received! Image and stats updated."
                      );
                    } else {
                      powerStatsDiv.style.display = "none";
                    }
                  } else {
                    // macmon not installed
                    macmonNote.style.display = "block";
                    appendStatus("macmon not installed, no power usage data.");
                  }
                } catch (err) {
                  appendStatus("JSON parse error: " + err.message);
                }
              } else {
                appendStatus(dataPart);
              }
            }
          }
        }
      });
    </script>
  </body>
</html>
